/**
 * audiowalk
 * @version v0.1.0 - 2014-09-13
 * @link https://github.com/lennart/audiowalk
 * @author Lennart Melzer ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
$(document).ready(function(){function e(e){return e*(Math.PI/180)}var t=$(".places"),o=function(){t.masonry({columnWidth:".place-small",itemSelector:".place"})},n=function(t,o){var n=t.latitude,a=t.longitude,l=o.latitude,r=o.longitude,i=6371,s=e(l-n),c=e(r-a),u=Math.sin(s/2)*Math.sin(s/2)+Math.cos(e(n))*Math.cos(e(l))*Math.sin(c/2)*Math.sin(c/2),d=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),g=i*d;return g},a=function(e,t){var o=$.Deferred();return setTimeout(function(){var t=e.apply(null,arguments);o.resolve(t)},t),o.promise()},l=function(){var e=$.Deferred();return a(function(){o()},500).then(function(){$.ajax("maps/home.gpx",{dataType:"xml"}).done(function(t){var o=toGeoJSON.gpx(t);e.resolve(o)}).fail(e.reject),o()}).fail(e.reject),e.promise()};l().done(function(e){console.log("this is home.js calling"),window.viewportUnitsBuggyfill.init();var t=function(){return $(window).width()>1200?14:13},a=t();$(".place").click(function(e){$(e.currentTarget).toggleClass("place-small").toggleClass("place-large"),$(e.currentTarget).siblings(".place-large").toggleClass("place-large"),o()});var l=L.map("map",{minZoom:13,maxZoom:17,fullscreenControl:!0,zoom:a,scrollWheelZoom:!1}).setView([52.2571198321276,10.5145982516365],a);$(window).resize(function(){13==a&&14==t()&&(l.setView([52.2571198321276,10.5145982516365],t()),l.maxZoom(14))}),l.locate({watch:!0});var r,i=function(e){r&&l.removeLayer(r),r=L.circleMarker(e.latlng,{color:"white",fillColor:"lightGreen",opacity:.9,fillOpacity:.7,className:"bnw-marker"}).setRadius(7),r.bindLabel("Ich",{noHide:!0,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"}),r.addTo(l),console.log("luv")},s=function(t){console.log("we are here",t.latlng,"Story",e);var o=e.features.map(function(e){var o=e.geometry.coordinates,a=t.latlng,l=n({longitude:o[0],latitude:o[1]},{longitude:a.lng,latitude:a.lat});return{location:e.properties,distance:l}});o=o.sort(function(e,t){return e.distance>t.distance?-1:e.distance<t.distance?1:0}).reverse(),console.log("distances to you",o)},c=function(e){console.error("failed finding you on the map",e),l.stopLocate()};l.on("locationfound",i),l.on("locationfound",s),l.on("locationerror",c),L.tileLayer("maps/home/tiles/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(l);var u=L.geoJson(null,{style:function(e){return"LineString"===e.geometry.type?(console.log("[map] styling",e),{color:"#168",opacity:1,dashArray:"10,10"}):{}},pointToLayer:function(e,t){var o=L.circleMarker(t,{color:"white",opacity:.8,fillOpacity:.8,fillColor:"red",className:"bnw-marker",dashArray:null}).setRadius(7);return o.bindLabel(e.properties.desc,{noHide:!1,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"})}}),d=function(e,t,o,n){var a=t.lng-e.lng,l=t.lat-e.lat,r=Math.sqrt(Math.pow(a,2)+Math.pow(l,2)),i=o*r,s=n*r;return{sw:{lng:e.lng-s,lat:e.lat-i},ne:{lng:t.lng+s,lat:t.lat+i}}},g="maps/home.gpx",p=omnivore.gpx(g,null,u).on("ready",function(){console.log("labelled route");var e=p.getBounds(),t=d(e.getSouthWest(),e.getNorthEast(),.4,1.5),o=L.latLngBounds(L.latLng(t.sw),L.latLng(t.ne));console.log("[map] padded bounds",o),l.setMaxBounds(o)}).addTo(l)})});