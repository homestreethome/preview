/**
 * audiowalk
 * @version v0.1.0 - 2014-08-31
 * @link https://github.com/lennart/audiowalk
 * @author Lennart Melzer ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var app=angular.module("lennart.Audiowalk",["ngAnimate","ngRoute","LocalStorageModule","ngTouch","ngSanitize","duScroll","leaflet-directive"]),debug=!1;app.constant("version","v0.1.0").config(["$locationProvider","$routeProvider","$logProvider","$provide",function(e,i,a,t){t.value("debugMode",debug),a.debugEnabled(debug),i.when("/",{templateUrl:"views/start.html"}).when("/credits",{templateUrl:"views/credits.html"}).when("/:slide?",{templateUrl:"views/slide.html"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","$log","localStorageService","$window","ApplicationCache","StoryBoard",function(e,i,a,t,n,o,d){e.online=navigator.onLine,o.init(),n.addEventListener("offline",function(){e.$apply(function(){e.online=!1})},!1),n.addEventListener("online",function(){e.$apply(function(){e.online=!0})},!1);var s=t.get("first-slide");s?(a.info("[app] starting from stored slide",s),d.reorderFrom(d.getSlide(s))):a.info("[app] starting at first slide")}]),app.factory("$exceptionHandler",function(){return function(e,i){e.message+=' (caused by "'+i+'")'}}),app.factory("StoryBoardIDException",function(){function e(){}return e}),app.controller("MainCtrl",["$scope","$location","version","$log","$window","StoryBoard","StoryBoardIDException","$routeParams","$rootScope","localStorageService","Audio","Geolocation",function(e,i,a,t,n,o,d,s,r,l,c,u){e.updateCurrentSlide=function(i){t.info("updating current slide",i),e.slide=o.getSlide(i),e.slideIndex=o.slideIndex(e.slide),e.nextSlide=o.nextSlide(e.slide),e.prevSlide=o.prevSlide(e.slide),t.debug("[main] slide change",{current:e.slide.id,next:e.nextSlide.id,prev:e.prevSlide.id})},r.$on("$routeChangeSuccess",function(a,n){if(e.isLastSlide=!1,"/"===i.path())t.info("[main] start me up");else{e.updateCurrentSlide(n.params.slide);var d=o.lastSlide().id;t.info("[main] last slide ID",d,"current",e.slide.id),d===e.slide.id?(e.isLastSlide=!0,t.info("[main] finished walk"),l.set("finished","yes")):t.info("[main] yet another slide:",e.slide.id)}}),r.$on("$routeChangeStart",function(){u.unwatch()}),e.changeSlide=function(e){i.path(e).replace(),r.$apply()},e.$watch("online",function(e){e?n.ga("send","event","system","change","online"):n.ga("send","event","system","change","offline")})}]),app.controller("StartCtrl",["$scope","$timeout","debugMode","ApplicationCache","$q","Geolocation","$location","version","$log","$window","StoryBoard","$routeParams","$rootScope","localStorageService","$document","$element","Audio",function(e,i,a,t,n,o,d,s,r,l,c,u,p,g,h,m,f){e.$path=d.path.bind(d),e.version=s,e.appReady=function(i,t){r.info("[app] ready because:",t),a?h.find("body").click(function(){e.loading=!1,e.loaded=!0,e.$apply()}):(e.loading=!1,e.loaded=!0)},e.appLoading=function(i,a){e.loading=!0,e.cachedPercentage=a.percentage,e.scrollingIntro||(r.info("[app] scrolling intro now"),e.scrollingIntro=!0,e.scrollIntro())},e.$on("app:ready",e.appReady),e.trackStartClick=function(){l.ga("send","event","button","click","start button"),r.info("Tracking click to start App")},p.$on("cache:ready",e.appReady),p.$on("cache:loading",e.appLoading);var y=function(){var e=n.defer();return"fixed"==c.dramaturgy?e.resolve(c.firstSlide()):o.current().then(function(i){var a,t=null,n=null;c.withAll(function(e){e.maps&&(r.info("[start] map",e.maps),a=o.distanceInKm(i.coords,e.maps.destination),n?n>a&&(n=a,t=e):(n=a,t=e))}),r.info("[start] shortestDistance",t),e.resolve(t)}).catch(function(){r.error("[start] failed finding current location, falling back to fixed story board dramaturgy"),e.resolve(c.firstSlide())}),e.promise};y().then(function(i){g.set("first-slide",i.id),c.reorderFrom(i),e.firstSlide=i}),e.credits=!1,e.loading=!1,e.loaded=!1,e.toggleCredits=function(){e.credits=e.credits===!1?!0:!1,e.credits===!0&&i(function(){h.scrollToElement(m.find("#credits-block"),l.screen.availHeight,5e4,function(e){return.5>e?2*e*e:-1+(4-2*e)*e}).then(function(){r.debug("no more scrolling credits")})})},f.set("credits","/audio/way/n.mp3"),f.pauseAll(),p.currentSound&&p.currentSound.stop(),e.scrollIntro=function(){i(function(){var e=m.find("#loading-bar-block");e.length&&h.scrollToElement(e,l.screen.availHeight-100,25e3,function(e){return.5>e?2*e*e:-1+(4-2*e)*e}).then(function(){r.info("intro scrolling finished")})})},"yes"==g.get("finished")?(g.set("finished","no"),r.info("[start] finished",g.get("finished")),f.play("credits"),i(function(){e.toggleCredits()},100),e.$emit("app:ready")):t.isLoading()?r.info("[app] caching resources"):(r.info("[app] go!"),e.$emit("app:ready","resume"))}]),app.controller("StoryBoardCtrl",["debugMode","$rootScope","$scope","$sce","$routeParams","StoryBoard","$log","$window","$element","$location","$timeout","Geolocation","$document","Audio",function(e,i,a,t,n,o,d,s,r,l,c,u,p,g){if(a.debugMode=e,a.tiles=a.slide.maps&&a.slide.maps.tiles?a.slide.maps.tiles:o.tiles,a.$on("map:destination:reached",function(){d.info("[story board] destination reached, vibrating, awareness, now!"),navigator.vibrate&&navigator.vibrate(1e3),a.notice="Ziel erreicht!",a.showNotice=!0,c(function(){d.debug("[story board] hide destination notice"),a.showNotice=!1},5e3),a.$emit("slide:change:request")}),a.$on("slide:change:request",function(){d.info("[story board] wants to change slide"),a.destinationReached&&a.soundEnded?(a.changeSlide(a.nextSlide?a.nextSlide.id:""),a.resetAutoChange()):d.info(a.destinationReached?"but first lets hear that sound till the end!":"but first we have to get to the destination!")}),a.$on("change:distance",function(e,i){d.debug("[story board] changed distance",arguments),c(function(){a.slide.distance=i},500)}),a.trackNextClick=function(){d.info("[tracking] next click"),s.ga("send","event","button","click","next slide")},a.trackPrevClick=function(){d.info("[tracking] prev click"),s.ga("send","event","button","click","prev slide")},a.trackPlayClick=function(){d.info("[tracking] play click"),s.ga("send","event","button","click","play slide")},a.trackPauseClick=function(){d.info("[tracking] pause click"),s.ga("send","event","button","click","pause slide")},a.resetAutoChange=function(){a.destinationReached=!1,a.soundEnded=!1},a.toggleAudio=function(){if(a.slide.audio){var e=g.audios[a.slide.id];d.debug("current audio",e),a.playing(a.slide.id)?(a.trackPauseClick(),e.pause()):(a.trackPlayClick(),e.play())}},a.jumpToEndOfAudio=function(){if(a.slide.audio){var e=g.audios[a.slide.id];e.isPaused()||e.setPercent(98)}},a.watchUserPosition=function(){d.info("[map] watching movements"),i.$on("geolocation:changed",function(e,i){if(a.destinationReached)d.debug("[story board] geolocation already reached, cease distance calc");else{{a.slide}if(a.slide.maps&&a.slide.maps.destination&&a.slide.maps.destination.latitude&&a.slide.maps.destination.longitude){d.debug(i.coords.latitude,i.coords.longitude,a.slide.maps.destination.latitude,a.slide.maps.destination.longitude);var t=u.distanceInKm(i.coords,a.slide.maps.destination);d.debug("distance",t),a.slide.destination_distance=Math.round(1e3*t*100)/100,a.$emit("change:distance",a.slide.destination_distance),.015>t?(d.debug("reached!",a.slide.id,a.nextSlide.id),a.destinationReached=!0,u.unwatch(),a.$emit("map:destination:reached")):d.debug("the waypoint is ",t,"away!")}else d.info("no destination")}}),i.$on("geolocation:error",function(e,i){d.error("Failed watching position",i)}),u.watch()},d.info("[story board ctrl] setting up slide values"),a.playing=g.playing,a.showNotice=!1,a.currentSlideNumber=a.slideIndex+1,a.totalSlides=o.totalSlides,g.pauseAll(),u.unwatch(),a.slide.maps?(a.watchUserPosition(),u.current().then(function(e){d.debug("current position",e),i.$emit("geolocation:changed",e)}).catch(function(e){d.error("Failed to read current Position",e)})):(a.destinationReached=!0,u.unwatch()),a.slide.audio){var h=g.audios[a.slide.id];h.bindOnce("ended",function(){a.soundEnded=!0,a.$emit("slide:change:request")}),h.play()}else a.soundEnded=!0}]),app.controller("MapCtrl",["$rootScope","$scope","$location","$log","leafletData","$element","$window",function(e,i,a,t,n,o,d){angular.extend(i,{defaults:{tileLayer:a.protocol()+"://"+a.host()+":"+a.port()+i.tiles.url,maxZoom:17,minZoom:16,tileLayerOptions:{attribution:"Data Â© OpenStreetMap (and) contributors, CC-BY-SA",maxZoom:17,maxNativeZoom:17}},center:{lat:52.2571198321276,lng:10.5145982516365,zoom:16},events:{map:{enable:["layeradd","drag","click","zoomstart","load"],logic:"emit"}}}),i.$on("leafletDirectiveMap.layeradd",function(){}),i.$on("leafletDirectiveMap.zoomstart",function(e,i){t.debug("[map] zooming",e,i)}),i.$on("leafletDirectiveMap.load",function(){n.getMap().then(function(e){o.css({position:"absolute",top:0,width:"100%",height:d.innerHeight+"px",zIndex:0,left:0}),e.invalidateSize()})}),n.getMap().then(function(e){t.info("[map] loaded");var a=L.geoJson(null,{style:function(e){return"LineString"===e.geometry.type?(t.debug("[map] styling",e),{color:"#168",opacity:1,dashArray:"10,10"}):{}},pointToLayer:function(e,i){t.debug("marker",i);var a=L.circleMarker(i,{color:"#49fb35",opacity:.8,fillOpacity:.8,fillColor:"#b8ffb1",className:"bnw-marker",dashArray:null}).setRadius(7);return a.bindLabel(e.properties.name,{noHide:!0,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"})}}),n=function(e,i,a){var t=i.lng-e.lng,n=i.lat-e.lat,o=Math.sqrt(Math.pow(t,2)+Math.pow(n,2)),d=a*o;return{sw:{lng:e.lng-d,lat:e.lat-d},ne:{lng:i.lng+d,lat:i.lat+d}}},o=i.slide.maps.route,d=omnivore.gpx(o,null,a).on("ready",function(){t.info("labelled route");var i=d.getBounds(),a=n(i.getSouthWest(),i.getNorthEast(),.05),o=L.latLngBounds(L.latLng(a.sw),L.latLng(a.ne));t.info("[map] padded bounds",o),e.setMaxBounds(o)}).addTo(e)}),e.$on("geolocation:changed",function(e,a){n.getMap().then(function(e){i.currentPositionMarker&&e.removeLayer(i.currentPositionMarker);var t=L.latLng(a.coords.latitude,a.coords.longitude);i.currentPositionMarker=L.circleMarker(t,{color:"#318",opacity:.8,fillOpacity:.8,fillColor:"#45f",dashArray:null}).setRadius(7),i.currentPositionMarker.bindLabel("Ich",{noHide:!0,direction:"verticalauto",offset:L.point(0,0),className:"bnw-marker-label"}).addTo(e)})})}]),app.service("Geolocation",["$rootScope","$window","$q","$log",function(e,i,a,t){function n(e){return e*(Math.PI/180)}var o=this,d=null;this.supportGeolocation=!!i.navigator,this.current=function(){var e=a.defer();return o.supportGeolocation?i.navigator.geolocation.getCurrentPosition(function(i){e.resolve(i)},function(i){e.reject(i)},{enableHighAccuracy:!0}):e.reject({message:"Device does not support Geolocation"}),e.promise},this.watch=function(){o.supportGeolocation?d=i.navigator.geolocation.watchPosition(function(i){e.$emit("geolocation:changed",i)},function(i){e.$emit("geolocation:error",i)},{enableHighAccuracy:!0}):e.$emit("geolocation:error","device does not support geolocation")},this.unwatch=function(){d&&(t.info("[geo] do not care about movements anymore"),i.navigator.geolocation.clearWatch(d))},this.distanceInKm=function(e,i){var a=e.latitude,t=e.longitude,o=i.latitude,d=i.longitude,s=6371,r=n(o-a),l=n(d-t),c=Math.sin(r/2)*Math.sin(r/2)+Math.cos(n(a))*Math.cos(n(o))*Math.sin(l/2)*Math.sin(l/2),u=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)),p=s*u;return p}}]),app.factory("StoryBoard",["$log","StoryBoardIDException",function(e,i){var a={name:"Home Street Home",dramaturgy:"fluid-entrance",tiles:{url:"/maps/default/tiles/{z}/{x}/{y}.png"},slides:[{id:"weg-zu-marlene-bart",caption:"Weg zu Marlene Bart",maps:{destination:{latitude:52.25783,longitude:10.525430000000028},route:"/maps/default.gpx",image:"/images/routes/1.png"},audio:"/audio/way/test.m4a",autoplay:!0},{id:"marlene-bar",caption:"Marlene Bart",audio:"/audio/slide/test.m4a",image:"/images/places/stoberholz.jpg"},{id:"weg-zu-timo-hoheisel",caption:"Weg zu Timo Hoheisel",maps:{destination:{latitude:52.25762,longitude:10.502280000000042},route:"/maps/default.gpx",image:"/images/routes/1.png"},audio:"/audio/way/test.m4a",autoplay:!0},{id:"timo-hoheisel",caption:"Timo Hoheisel",audio:"/audio/slide/test.m4a",image:"/images/places/haus_aus_einem_anderen_land.jpg"},{id:"weg-zu-phoebe-pia-hartmann",caption:"Weg zu Phoebe Pia Hartmann",maps:{destination:{latitude:52.258128,longitude:10.50622169999997},route:"/maps/default.gpx",image:"/images/routes/2.png",zoom:16},audio:"/audio/way/test.m4a",autoplay:!0},{id:"phoebe-pia-hartmann",caption:"Phoebe Pia Hartmann",audio:"/audio/slide/test.m4a",image:"/images/places/leihamt.jpg"},{id:"weg-zu-jonny-isaak-und-nina-nyusha-rezagholina",caption:"Weg zu Jonny Isaak & Nina Nyusha Rezagholina",maps:{destination:{latitude:52.52899,longitude:13.3984},route:"/maps/default.gpx",image:"/images/routes/3.png",waypoints:[{location:"LinienstraÃe 98, Berlin, Germany"}]},audio:"/audio/way/test.m4a",autoplay:!0},{id:"jonny-isaak-und-nina-nyusha-rezagholina",caption:"Jonny Isaak & Nina Nyusha Rezagholina",audio:"/audio/slide/test.m4a",image:"/images/places/leerstehendes_haus.jpg"},{id:"weg-zu-aaron-israel",caption:"Weg zu Aaron Israel",maps:{destination:{latitude:52.2612284,longitude:10.506162300000028},image:"/images/routes/4.png",route:"/maps/default.gpx",waypoints:[{location:"LinienstraÃe 86, Berlin, Germany"}]},audio:"/audio/way/test.m4a"},{id:"aaron-israel",caption:"Aaron Israel",audio:"/audio/slide/test.m4a",image:"/images/places/besetztes_haus.jpg"},{id:"weg-zu-sven-julien-kanclerski-und-carolin-steinkamp",caption:"Weg zu Sven-Julien Kanclerski & Carolin Steinkamp",maps:{destination:{latitude:52.24938,longitude:10.502380000000016},image:"/images/routes/5.png",route:"/maps/default.gpx",waypoints:[{location:"LinienstraÃe 206, Berlin, Germany"}]},audio:"/audio/way/test.m4a"},{id:"sven-julien-kanclerski-und-carolin-steinkamp",caption:"Sven-Julien Kanclerski & Carolin Steinkamp",audio:"/audio/slide/test.m4a",image:"/images/places/garnisonsfriedhof.jpg"},{id:"weg-zu-swetlana-koenig",caption:"Weg zu Swetlana KÃ¶nig",maps:{destination:{latitude:52.2618109,longitude:10.49794959999997},image:"/images/routes/6.png",route:"/maps/default.gpx"},audio:"/audio/way/test.m4a"},{id:"swetlana-koenig",caption:"Swetlana KÃ¶nig",audio:"/audio/slide/test.m4a",image:"/images/places/arbeitsnachweis.jpg"},{id:"weg-zu-alissa-lillepea",caption:"Weg zu Alissa Lillepea",maps:{destination:{latitude:52.25344,longitude:10.507820000000038},image:"/images/routes/7.png",route:"/maps/default.gpx"},audio:"/audio/way/test.m4a"},{id:"Alissa Lillepea",caption:"Wunschgarten",audio:"/audio/slide/test.m4a",image:"/images/places/wunschgarten.jpg"},{id:"weg-zu-nils-peter",caption:"Weg zu Nils Peter",maps:{destination:{latitude:52.25468559999999,longitude:10.509174499999972},image:"/images/routes/8.png",route:"/maps/default.gpx"},audio:"/audio/way/test.m4a"},{id:"nils-peter",caption:"Nils Peter",audio:"/audio/slide/test.m4a",image:"/images/places/volksbuehne.jpg"},{id:"weg-zu-sarah-schoberth",caption:"Weg zu Sarah Schoberth",maps:{destination:{latitude:52.2495489,longitude:10.503373900000042},image:"/images/routes/9.png",route:"/maps/default.gpx",waypoints:[{location:"52.527049,13.411903"}]},audio:"/audio/way/test.m4a"},{id:"sarah-schoberth",caption:"Sarah Schoberth",image:"/images/places/arbeiterdenkmal.jpg",audio:"/audio/slide/test.m4a"},{id:"weg-zu-deborah-uhde",caption:"Deborah Uhde",maps:{destination:{latitude:52.2667327,longitude:10.536348399999952},image:"/images/routes/10.png",route:"/maps/deborah-uhde.gpx",tiles:{url:"/maps/deborah-uhde/tiles/{z}/{x}/{y}.png"},waypoints:[{location:"52.525248,13.413445"}]},audio:"/audio/way/test.m4a"},{id:"deborah-uhde",caption:"Deborah Uhde",audio:"/audio/slide/test.m4a",image:"/images/places/karl-liebknecht-haus.jpg"}]},t={isValidSlideID:function(e){return!!a.slides[t.idToSlideIndex(e)]},idToSlideIndex:function(e){var i=a.slides.filter(function(i){return i.id==e});return i[0]?a.slides.indexOf(i[0]):-1},indexToSlideId:function(e){var i;return(i=a.slides[e])?i.id:null}},n={reorderFrom:function(i){var n=a.slides.splice(0,t.idToSlideIndex(i.id));a.slides=a.slides.concat(n),e.info("[story board] new order",a.slides)},withAll:function(e){angular.forEach(a.slides,e)},getSlide:function(e){if(t.isValidSlideID(e))return a.slides[t.idToSlideIndex(e)];throw new i},nextSlide:function(i){var n=t.idToSlideIndex(i.id);return e.info("[story board] next Slide for",i.id,n),n===a.slides.length-1?a.slides[0]:a.slides[n+1]},prevSlide:function(i){var n=t.idToSlideIndex(i.id);return e.info("[story board] prev Slide for",i.id,n),0===n?a.slides[a.slides.length-1]:a.slides[n-1]},lastSlide:function(){return a.slides[n.totalSlides-1]},firstSlide:function(){return a.slides[0]},slideIndex:function(e){return t.idToSlideIndex(e.id)},totalSlides:a.slides.length,name:a.name,dramaturgy:a.dramaturgy,tiles:a.tiles};return n}]),app.service("Audio",["$q","$log","StoryBoard","$rootScope","$timeout",function(e,i,a,t,n){var o=this,d=this.audios={};a.withAll(function(e){e.audio&&(d[e.id]=new buzz.sound(e.audio))}),this.set=function(e,i){d[e]=new buzz.sound(i)},this.play=function(e){var i=d[e];return i?(i.play(),i):!1},this.delayedStartStop=function(e,i){i=i||100;var a=d[e];a.play();var t=function(){a.pause()};return n(t,i,!0)},this.ensureAutoplay=function(){var i=(e.defer(),a.slides.filter(function(e){return!!e.audio}).map(function(e){return o.delayedStartStop(e.id,100)}));return e.all(i)},this.pauseAll=function(){return angular.forEach(d,function(e){e.pause()}),!0},this.playing=function(e){var i=d[e];return i?!i.isPaused():!1}}]),app.service("ApplicationCache",["$log","$window","$rootScope",function(e,i,a){var t=this,n={loaded:0,total:0,ready:!1,percentage:0},o=i.applicationCache;this.isAvailable=function(){return!!o},this.isLoading=function(){if(!this.isAvailable())return!1;switch(o.status){case i.applicationCache.IDLE:case i.applicationCache.UNCACHED:return!1;default:return!0}},this.isCached=function(){return this.isAvailable()?o.status===i.applicationCache.IDLE:!1},this.handleEvent=function(i){switch(e.debug("[cache] event",i,t.progress),i.type){case"checking":a.$emit("cache:loading",n);break;case"downloading":a.$emit("cache:loading",n);break;case"error":t.isCached()?(a.$emit("cache:ready","error"),a.$apply()):location.reload();break;case"noupdate":n.percentage="100%",a.$emit("cache:ready","noupdate"),a.$apply();break;case"progress":n.percentage=i.loaded/i.total*100+"%",n.total=i.total,n.loaded=i.loaded,a.$emit("cache:loading",n),a.$apply();break;case"cached":n.percentage="100%",a.$emit("cache:ready","cached"),a.$apply(),a.$apply();break;case"updateready":n.percentage="100%",a.$emit("cache:ready","updateready"),a.$apply()}},this.init=function(){this.isAvailable()?(e.info("[cache] application cache available"),o.addEventListener("error",this.handleEvent,!1),o.addEventListener("checking",this.handleEvent,!1),o.addEventListener("noupdate",this.handleEvent,!1),o.addEventListener("downloading",this.handleEvent,!1),o.addEventListener("progress",this.handleEvent,!1),o.addEventListener("updateready",this.handleEvent,!1),o.addEventListener("cached",this.handleEvent,!1),this.isLoading()?a.$emit("cache:loading",n):e.info("[cache] not loading on init")):e.info("[cache] no application cache, no love")}}]);